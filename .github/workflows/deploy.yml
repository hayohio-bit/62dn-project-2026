name: DN Platform Deploy

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Build Backend
        run: |
          cd backend
          ./gradlew clean bootJar -x test
          ls -la build/libs/*.jar

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Build Frontend
        env:
          VITE_API_BASE_URL: /api
          VITE_MAP_API_KEY: ${{ secrets.VITE_MAP_API_KEY }}
        run: |
          cd frontend
          npm ci
          npm run build
          ls -la dist/

      - name: Create deploy package
        run: |
          mkdir -p deploy
          cp backend/build/libs/platform-0.0.1-SNAPSHOT.jar deploy/
          cp -r frontend/dist deploy/frontend-dist
          cp docs/migrations/V5__add_sync_history.sql deploy/
          tar -czvf deploy.tar.gz deploy/

      - name: Verify secrets (DB 연결용)
        run: |
          missing=""
          [ -z "${{ secrets.RDS_ENDPOINT }}" ] && missing="RDS_ENDPOINT $missing"
          [ -z "${{ secrets.RDS_USERNAME }}" ] && missing="RDS_USERNAME $missing"
          [ -z "${{ secrets.RDS_PASSWORD }}" ] && missing="RDS_PASSWORD $missing"
          [ -z "${{ secrets.EC2_HOST }}" ] && missing="EC2_HOST $missing"
          [ -z "${{ secrets.EC2_SSH_KEY }}" ] && missing="EC2_SSH_KEY $missing"
          if [ -n "$missing" ]; then
            echo "::error::필수 시크릿이 비어 있음: $missing (GitHub Settings → Secrets and variables → Actions 확인)"
            exit 1
          fi
          echo "[배포] RDS/EC2 시크릿 존재 확인 완료 (값은 로그에 출력하지 않음)"

      - name: Deploy to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "deploy.tar.gz"
          target: "/home/ec2-user/"

      - name: Extract and Restart on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 5m
          envs: RDS_ENDPOINT,RDS_USERNAME,RDS_PASSWORD,JWT_SECRET,JWT_ACCESS_VALIDITY,JWT_REFRESH_VALIDITY,RESEND_API_KEY,RESEND_FROM_EMAIL,DATA_API_KEY,FRONTEND_URL,PUBLIC_API_SYNC_ENABLED,PUBLIC_API_SYNC_CRON
          script: |
            set -e
            cd /home/ec2-user
            if [ -z "${RDS_ENDPOINT}" ]; then
              echo "[배포 오류] RDS_ENDPOINT가 EC2에 전달되지 않음. GitHub Actions envs/시크릿 확인 필요."
              exit 1
            fi
            tar -xzvf deploy.tar.gz
            mkdir -p app
            cp deploy/platform-0.0.1-SNAPSHOT.jar app/
            sudo mkdir -p /var/www/dn-platform
            sudo cp -r deploy/frontend-dist/* /var/www/dn-platform/
            sudo tee /etc/nginx/conf.d/dn-platform.conf > /dev/null << 'NGINX'
            server {
                listen 80;
                server_name _;
                root /var/www/dn-platform;
                index index.html;
                try_files $uri $uri/ /index.html;
                location /api/ {
                    proxy_pass http://127.0.0.1:8080;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                }
                location /swagger-ui {
                    proxy_pass http://127.0.0.1:8080;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                }
                location /v3/api-docs {
                    proxy_pass http://127.0.0.1:8080;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                }
                location = /swagger-ui.html {
                    proxy_pass http://127.0.0.1:8080;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                }
            }
            NGINX
            sudo sed -i 's/^[[:space:]]*//' /etc/nginx/conf.d/dn-platform.conf
            sudo nginx -t && sudo systemctl reload nginx
            # sync_history 테이블이 없으면 백엔드 기동 실패 → 동물 목록 등 API 실패. 배포 시 마이그레이션 선행 적용.
            if ! command -v mysql >/dev/null 2>&1; then
              sudo yum install -y mariadb 2>/dev/null || sudo yum install -y mariadb105 2>/dev/null || sudo dnf install -y mariadb105 2>/dev/null || true
            fi
            if command -v mysql >/dev/null 2>&1; then
              export MYSQL_PWD="${RDS_PASSWORD}"
              mysql -h "${RDS_ENDPOINT}" -u "${RDS_USERNAME}" dn_platform < deploy/V5__add_sync_history.sql || echo "[배포] V5 마이그레이션 실행 실패(위 로그 확인). 백엔드는 재시작됨."
              unset MYSQL_PWD
            else
              echo "[배포] mysql 클라이언트 없음. sync_history는 앱 기동 시 Flyway가 생성 시도."
            fi
            DB_URL="jdbc:mysql://${RDS_ENDPOINT}/dn_platform?useSSL=false&serverTimezone=Asia/Seoul&characterEncoding=UTF-8"
            if [ -n "${FRONTEND_URL}" ]; then
              CORS_ORIGINS="http://localhost:5173,http://localhost:3000,${FRONTEND_URL}"
            else
              CORS_ORIGINS="http://localhost:5173,http://localhost:3000"
            fi
            cat > app/start.sh << START
            #!/bin/bash
            cd /home/ec2-user/app
            exec java -jar -Dspring.profiles.active=prod platform-0.0.1-SNAPSHOT.jar \
              --spring.datasource.url="${DB_URL}" \
              --spring.datasource.username="${RDS_USERNAME}" \
              --spring.datasource.password="${RDS_PASSWORD}" \
              --jwt.secret="${JWT_SECRET}" \
              --jwt.access-token-validity="${JWT_ACCESS_VALIDITY:-86400}" \
              --jwt.refresh-token-validity="${JWT_REFRESH_VALIDITY:-2592000}" \
              --resend.api-key="${RESEND_API_KEY}" \
              --resend.from-email="${RESEND_FROM_EMAIL}" \
              --public-api.service-key="${DATA_API_KEY}" \
              --public-api.sync-enabled="${PUBLIC_API_SYNC_ENABLED:-false}" \
              --public-api.sync-cron="${PUBLIC_API_SYNC_CRON:-0 0 17 * * *}" \
              --app.frontend-url="${FRONTEND_URL}" \
              --cors.allowed-origins="${CORS_ORIGINS}"
            START
            sed -i 's/^[[:space:]]*//' app/start.sh
            chmod +x app/start.sh
            if grep -q 'jdbc:mysql://' app/start.sh && grep -q 'dn_platform' app/start.sh; then
              echo "[배포] start.sh DB URL 설정 확인됨 (jdbc:mysql://.../dn_platform)"
            else
              echo "[배포 경고] start.sh에 DB URL이 기대한 형식으로 없음. cat app/start.sh 로 확인 필요."
            fi
            if [ ! -f /etc/systemd/system/dn-platform.service ]; then
              sudo tee /etc/systemd/system/dn-platform.service > /dev/null << 'SVC'
            [Unit]
            Description=DN Platform Backend
            After=network.target

            [Service]
            Type=simple
            User=ec2-user
            WorkingDirectory=/home/ec2-user/app
            ExecStart=/home/ec2-user/app/start.sh
            Restart=on-failure
            RestartSec=5
            StandardOutput=append:/home/ec2-user/log.out
            StandardError=append:/home/ec2-user/err.out

            [Install]
            WantedBy=multi-user.target
            SVC
              sudo sed -i 's/^[[:space:]]*//' /etc/systemd/system/dn-platform.service
              sudo systemctl daemon-reload
              sudo systemctl enable dn-platform
            fi
            sudo systemctl restart dn-platform
            sleep 3
            sudo systemctl is-active dn-platform && echo "[배포] dn-platform 서비스 기동됨" || echo "[배포 경고] dn-platform 서비스 비활성"
            echo "[배포] err.out 마지막 30줄 (DB 연결 오류 확인용):"
            tail -30 /home/ec2-user/err.out 2>/dev/null || true
            rm -f /home/ec2-user/deploy.tar.gz
        env:
          RDS_ENDPOINT: ${{ secrets.RDS_ENDPOINT }}
          RDS_USERNAME: ${{ secrets.RDS_USERNAME }}
          RDS_PASSWORD: ${{ secrets.RDS_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_ACCESS_VALIDITY: ${{ secrets.JWT_ACCESS_VALIDITY }}
          JWT_REFRESH_VALIDITY: ${{ secrets.JWT_REFRESH_VALIDITY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          RESEND_FROM_EMAIL: ${{ secrets.RESEND_FROM_EMAIL }}
          DATA_API_KEY: ${{ secrets.DATA_API_KEY }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          PUBLIC_API_SYNC_ENABLED: ${{ secrets.PUBLIC_API_SYNC_ENABLED }}
          PUBLIC_API_SYNC_CRON: ${{ secrets.PUBLIC_API_SYNC_CRON }}
