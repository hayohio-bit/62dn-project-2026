<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::section}, 'Animal Form')}">
<section>
    <div class="card shadow-sm">
        <div class="card-header bg-light fw-bold">
            동물 정보 등록/수정
        </div>
        <div class="card-body p-4">
            <form id="animalForm">
                <input type="hidden" id="animalId" th:value="${animal != null ? animal.id : ''}">
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="name" class="form-label">이름</label>
                        <input type="text" class="form-control" id="name" th:value="${animal != null ? animal.name : ''}" required>
                    </div>
                    <div class="col-md-6">
                        <label for="species" class="form-label">종 (Dog, Cat 등)</label>
                        <input type="text" class="form-control" id="species" th:value="${animal != null ? animal.species : ''}" required>
                    </div>
                </div>
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="breed" class="form-label">품종</label>
                        <input type="text" class="form-control" id="breed" th:value="${animal != null ? animal.breed : ''}">
                    </div>
                    <div class="col-md-3">
                        <label for="age" class="form-label">나이</label>
                        <input type="number" class="form-control" id="age" th:value="${animal != null ? animal.age : ''}">
                    </div>
                    <div class="col-md-3">
                        <label for="gender" class="form-label">성별</label>
                        <select class="form-select" id="gender">
                            <option value="Male" th:selected="${animal != null && animal.gender == 'Male'}">수컷</option>
                            <option value="Female" th:selected="${animal != null && animal.gender == 'Female'}">암컷</option>
                        </select>
                    </div>
                </div>
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label for="weight" class="form-label">몸무게 (kg)</label>
                        <input type="number" step="0.1" class="form-control" id="weight" th:value="${animal != null ? animal.weight : ''}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label d-block">중성화 여부</label>
                        <div class="form-check form-check-inline mt-1">
                            <input class="form-check-input" type="radio" name="neutered" id="neuteredY" value="true" th:checked="${animal != null && animal.neutered}">
                            <label class="form-check-label" for="neuteredY">완료</label>
                        </div>
                        <div class="form-check form-check-inline mt-1">
                            <input class="form-check-input" type="radio" name="neutered" id="neuteredN" value="false" th:checked="${animal == null || !animal.neutered}">
                            <label class="form-check-label" for="neuteredN">미완료</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label for="status" class="form-label">상태</label>
                        <select class="form-select" id="status">
                            <option th:each="enumStatus : ${T(com.antigravity.animal.entity.AnimalStatus).values()}" 
                                    th:value="${enumStatus}" 
                                    th:text="${enumStatus}"
                                    th:selected="${animal != null && animal.status == enumStatus}">AVAILABLE</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="healthStatus" class="form-label">건강 상태</label>
                    <textarea class="form-control" id="healthStatus" rows="2" th:text="${animal != null ? animal.healthStatus : ''}"></textarea>
                </div>
                <div class="mb-3">
                    <label for="imageFile" class="form-label">대표 이미지</label>
                    <input type="file" class="form-control" id="imageFile" accept="image/*">
                </div>
                
                <div class="text-end mt-4">
                    <a th:href="@{/animals}" class="btn btn-secondary">취소</a>
                    <button type="button" class="btn btn-primary" onclick="submitAnimal()">저장하기</button>
                </div>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
        async function submitAnimal() {
            const animalId = document.getElementById('animalId').value;
            const data = {
                name: document.getElementById('name').value,
                species: document.getElementById('species').value,
                breed: document.getElementById('breed').value,
                age: document.getElementById('age').value,
                gender: document.getElementById('gender').value,
                weight: document.getElementById('weight').value,
                neutered: document.querySelector('input[name="neutered"]:checked').value === 'true',
                healthStatus: document.getElementById('healthStatus').value,
                status: document.getElementById('status').value
            };

            const method = animalId ? 'PUT' : 'POST';
            const url = animalId ? `/api/animals/${animalId}` : '/api/animals';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('저장 실패');
                
                const savedAnimal = await response.json();
                
                // 이미지 업로드가 있으면 수행
                const imageFile = document.getElementById('imageFile').files[0];
                if (imageFile) {
                    const formData = new FormData();
                    formData.append('file', imageFile);
                    await fetch(`/api/files/upload/animal/${savedAnimal.id}`, {
                        method: 'POST',
                        body: formData
                    });
                }
                
                alert('저장되었습니다.');
                location.href = '/animals/' + savedAnimal.id;
            } catch (err) {
                alert(err.message);
            }
        }
    </script>
</section>
</html>
